!function(r,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/common/http"),require("@angular/core"),require("@knora/core"),require("moment"),require("rxjs/operators"),require("@angular/router"),require("rxjs"),require("@angular/forms"),require("@angular/common"),require("@angular/material"),require("@knora/action")):"function"==typeof define&&define.amd?define("@knora/authentication",["exports","@angular/common/http","@angular/core","@knora/core","moment","rxjs/operators","@angular/router","rxjs","@angular/forms","@angular/common","@angular/material","@knora/action"],e):e((r.knora=r.knora||{},r.knora.authentication={}),r.ng.common.http,r.ng.core,null,null,r.rxjs.operators,r.ng.router,r.rxjs,r.ng.forms,r.ng.common,r.ng.material,null)}(this,function(r,e,t,i,o,n,s,a,u,l,c,g){"use strict";var d=o,p=function(){function r(r,e,t){this._http=r,this.config=e,this._users=t,this.MAX_SESSION_TIME=864e5}return r.prototype.setSession=function(o,r){var n=this;this.session={id:this.setTimestamp(),user:{name:r,jwt:o,lang:"en",sysAdmin:!1}},localStorage.setItem("session",JSON.stringify(this.session)),this._users.getUserByUsername(r).subscribe(function(r){var e=!1,t=r.permissions;t.groupsPerProject[i.KnoraConstants.SystemProjectIRI]&&(e=-1<t.groupsPerProject[i.KnoraConstants.SystemProjectIRI].indexOf(i.KnoraConstants.SystemAdminGroupIRI)),n.session={id:n.setTimestamp(),user:{name:r.username,jwt:o,lang:r.lang,sysAdmin:e}},localStorage.setItem("session",JSON.stringify(n.session))},function(r){console.error(r)})},r.prototype.setTimestamp=function(){return d().add(0,"second").valueOf()},r.prototype.getSession=function(){},r.prototype.updateSession=function(){},r.prototype.validateSession=function(){this.session=JSON.parse(localStorage.getItem("session"));var r=this.setTimestamp();return!!this.session&&(!(this.session.id+this.MAX_SESSION_TIME<r)||(this.authenticate()?(this.session.id=r,localStorage.setItem("session",JSON.stringify(this.session)),!0):(this.destroySession(),!1)))},r.prototype.authenticate=function(){return this._http.get(this.config.api+"/v2/authentication").pipe(n.map(function(r){return 200===r.status}))},r.prototype.destroySession=function(){localStorage.removeItem("session")},r.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],r.ctorParameters=function(){return[{type:e.HttpClient},{type:undefined,decorators:[{type:t.Inject,args:[i.KuiCoreConfigToken]}]},{type:i.UsersService}]},r.ngInjectableDef=t.defineInjectable({factory:function(){return new r(t.inject(e.HttpClient),t.inject(i.KuiCoreConfigToken),t.inject(i.UsersService))},token:r,providedIn:"root"}),r}(),m=function(){function r(r,e){this._session=r,this._router=e}return r.prototype.canActivate=function(r,e){return!!this._session.validateSession()||(this._router.navigate(["login"],{queryParams:{returnUrl:e.url}}),!1)},r.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],r.ctorParameters=function(){return[{type:p},{type:s.Router}]},r.ngInjectableDef=t.defineInjectable({factory:function(){return new r(t.inject(p),t.inject(s.Router))},token:r,providedIn:"root"}),r}(),f=function(){function r(r,e,t){this.http=r,this._session=e,this.config=t}return r.prototype.session=function(){return this._session.validateSession()},r.prototype.login=function(r,e){var t=this;return this.http.post(this.config.api+"/v2/authentication",{username:r,password:e},{observe:"response"}).pipe(n.map(function(r){return r}),n.catchError(function(r){return t.handleRequestError(r)}))},r.prototype.logout=function(){localStorage.removeItem("session")},r.prototype.handleRequestError=function(r){var e=new i.ApiServiceError;return e.status=r.status,e.statusText=r.statusText,e.errorInfo=r.message,e.url=r.url,a.throwError(e)},r.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],r.ctorParameters=function(){return[{type:e.HttpClient},{type:p},{type:undefined,decorators:[{type:t.Inject,args:[i.KuiCoreConfigToken]}]}]},r.ngInjectableDef=t.defineInjectable({factory:function(){return new r(t.inject(e.HttpClient),t.inject(p),t.inject(i.KuiCoreConfigToken))},token:r,providedIn:"root"}),r}(),h=function(){function r(r,e,t,o,n){this._auth=r,this._session=e,this._fb=t,this._route=o,this._router=n,this.loading=!1,this.loginErrorUser=!1,this.loginErrorPw=!1,this.loginErrorServer=!1,this.login={title:"Login",name:"Username",pw:"Password",button:"Login",remember:"Remember me",forgot_pw:"Forgot password?",error:{failed:"Password or username is wrong",server:"There's an error with the server connection. Try it again later or inform the Knora Team"}},this.formErrors={username:"",password:""},this.validationMessages={username:{required:"user name is required."},password:{required:"password is required"}}}return r.prototype.ngOnInit=function(){this._session.validateSession()?this.loggedInUser=JSON.parse(localStorage.getItem("session")).user.name:this.buildForm()},r.prototype.buildForm=function(){var e=this;this.frm=this._fb.group({username:["",u.Validators.required],password:["",u.Validators.required]}),this.frm.valueChanges.subscribe(function(r){return e.onValueChanged(r)})},r.prototype.onValueChanged=function(r){var o=this;if(this.frm){var n=this.frm;Object.keys(this.formErrors).map(function(e){o.formErrors[e]="";var r=n.get(e);if(r&&r.dirty&&!r.valid){var t=o.validationMessages[e];Object.keys(r.errors).map(function(r){o.formErrors[e]+=t[r]+" "})}})}},r.prototype.doLogin=function(){var e=this;if(this.errorMessage=undefined,this.loginErrorUser=!1,this.loginErrorPw=!1,this.loginErrorServer=!1,this.frm.invalid)return this.loginErrorPw=!0,void(this.loginErrorUser=!0);this.loading=!0;var t=this.frm.get("username").value,r=this.frm.get("password").value;this._auth.login(t,r).subscribe(function(r){e._session.setSession(r.body.token,t),setTimeout(function(){e.returnUrl=e._route.snapshot.queryParams.returnUrl||"/",e.navigate?e._router.navigate([e.navigate]):e._router.navigate([e.returnUrl]),e.loading=!1},2e3)},function(r){0===r.status&&(e.loginErrorUser=!1,e.loginErrorPw=!1,e.loginErrorServer=!0),401===r.status&&(e.loginErrorUser=!1,e.loginErrorPw=!0,e.loginErrorServer=!1),404===r.status&&(e.loginErrorUser=!0,e.loginErrorPw=!1,e.loginErrorServer=!1),e.errorMessage=r,e.loading=!1})},r.prototype.logout=function(){this._auth.logout(),location.reload(!0)},r.decorators=[{type:t.Component,args:[{selector:"kui-login-form",template:'<div class="login-form" *ngIf="!loggedInUser">\n    <div class="login-form-header">\n        <h3 mat-subheader>{{login.title}}</h3>\n    </div>\n    <div class="login-form-content">\n        \x3c!-- This is the login form --\x3e\n        <form class="login-form" [formGroup]="frm" (ngSubmit)="doLogin()">\n            \x3c!-- Error message --\x3e\n            <mat-hint *ngIf="errorMessage !== undefined" class="full-width">\n                <span *ngIf="loginErrorUser || loginErrorPw">{{login.error.failed}}</span>\n                <span *ngIf="loginErrorServer">{{login.error.server}}</span>\n            </mat-hint>\n\n            \x3c!-- Username --\x3e\n            <mat-form-field class="full-width login-field">\n                <mat-icon matPrefix>person</mat-icon>\n                <input matInput autofocus [placeholder]="login.name" autocomplete="username" formControlName="username">\n                <mat-hint *ngIf="formErrors.username" class="login-error">{{login.error.failed}}</mat-hint>\n            </mat-form-field>\n\n            \x3c!-- Password --\x3e\n            <mat-form-field class="full-width login-field">\n                <mat-icon matPrefix>lock</mat-icon>\n                <input matInput type="password" [placeholder]="login.pw" autocomplete="current-password" formControlName="password">\n                <mat-hint *ngIf="formErrors.password" class="login-error">{{login.error.failed}}</mat-hint>\n            </mat-form-field>\n\n            \x3c!-- Button: Login --\x3e\n            <div class="button-row full-width">\n                <button mat-raised-button type="submit"\n                        *ngIf="!loading"\n                        [disabled]="!frm.valid"\n                        class="full-width submit-button mat-primary">\n                    {{login.button}}\n                </button>\n                <kui-progress-indicator *ngIf="loading" [color]="color"></kui-progress-indicator>\n            </div>\n        </form>\n    </div>\n</div>\n\n\x3c!-- a user is already logged in; show who it is and a logout button --\x3e\n\n<div class="logout-form" *ngIf="loggedInUser">\n    <p>A user is already logged in:</p>\n    <p>{{loggedInUser}}</p>\n    <br>\n    <p>If it\'s not you, please logout!</p>\n    <div class="button-row full-width">\n        <button mat-raised-button\n                (click)="logout()"\n                *ngIf="!loading"\n                class="full-width mat-warn">\n            LOGOUT\n        </button>\n        <kui-progress-indicator *ngIf="loading"></kui-progress-indicator>\n    </div>\n</div>\n',styles:[".full-width{width:100%}.button-row,.mat-form-field,.mat-hint{margin-top:24px}.mat-hint{background:rgba(239,83,80,.39);display:block;margin-left:-16px;padding:16px;text-align:center;width:280px}.login-form,.logout-form{margin-left:auto;margin-right:auto;position:relative;width:280px}.login-form .login-form-header,.logout-form .login-form-header{margin-bottom:24px}.login-form .login-field .mat-icon,.logout-form .login-field .mat-icon{font-size:20px;margin-right:12px}.login-form .button-row,.logout-form .button-row{margin-top:48px}.sign-up{margin-top:24px}"]}]}],r.ctorParameters=function(){return[{type:f},{type:p},{type:u.FormBuilder},{type:s.ActivatedRoute},{type:s.Router}]},r.propDecorators={navigate:[{type:t.Input}],color:[{type:t.Input}]},r}(),v=function(){function r(r){this._session=r}return r.prototype.intercept=function(r,e){if(this._session.validateSession()){var t=JSON.parse(localStorage.getItem("session")).user.jwt;r=r.clone({setHeaders:{Authorization:"Bearer "+t}})}else this._session.destroySession();return e.handle(r)},r.decorators=[{type:t.Injectable}],r.ctorParameters=function(){return[{type:p}]},r}(),y=function(){function r(r){this._session=r}return r.prototype.intercept=function(r,e){return r=r.clone({withCredentials:!0}),e.handle(r)},r.decorators=[{type:t.Injectable}],r.ctorParameters=function(){return[{type:p}]},r}(),I=function(){function r(){}return r.decorators=[{type:t.NgModule,args:[{imports:[l.CommonModule,g.KuiActionModule,c.MatCardModule,c.MatIconModule,c.MatInputModule,c.MatButtonModule,c.MatDialogModule,c.MatFormFieldModule,u.ReactiveFormsModule,e.HttpClientModule],declarations:[h],exports:[h],providers:[{provide:e.HTTP_INTERCEPTORS,useClass:v,multi:!0},{provide:e.HTTP_INTERCEPTORS,useClass:y,multi:!0}]}]}],r}();r.ɵb=v,r.ɵc=y,r.ɵa=p,r.AuthGuard=m,r.LoginFormComponent=h,r.AuthenticationService=f,r.KuiAuthenticationModule=I,Object.defineProperty(r,"__esModule",{value:!0})});
//# sourceMappingURL=knora-authentication.umd.min.js.map